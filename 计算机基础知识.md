# 计算机组成原理

计算机系统的基本组成：硬件+软件

- 硬件的基本组成：运算器 + 控制器 + 存储器  + 输入设备 + 输出设备

- 软件组成：系统软件（如**操作系统**，数据库管理系统） 和 应用软件（QQ等）。

计算机特点：

1. 指令和数据都使用二进制表示，位于存储器中，需要使用地址访问。

2. **指令有 操作码 和 地址码 组成**。

3. 冯诺依曼计算机强调以运算器为中心，当代计算机强调以存储器为中心，因为如果所有事情都交给运算器的话那么运算器的执行效率会降低。

## 存储器

存储器理解为就是存储数据的地方，可以按照不同的类型来分。这里只介绍主存储器（内存）和辅助存储器（磁盘，硬盘），高速缓冲存储器（Cache）

**主存储器**是由 **存储体**，**地址寄存器(MAR)**，**数据寄存器(MDR)**，**时序控制逻辑**组成。

- 存储体：存放数据的地方，可以理解为就是**内存**。而**主存储器主要有存储体组成，所以可以理解为存储器就是内存**。

- 其他三个组件主要是临时存储要操作的数据，例如地址，数据，时序信号等。

辅助存储器就是辅助主内存的存储器，容量大，但读取速度慢，例如磁盘，硬盘。

**高速缓冲存储器Cache**是为了弥补CPU跟主内存之间读取数据速度的差异（空等现象）。为什么加了缓存就可以解决空等现象呢？因为有时间局部性和空间局部性原理。

- 时间局部性：**如果一个数据现在被访问了，那么以后很有可能也会被访问**

- 空间局部性：**如果一个数据现在被访问了，那么它周围的数据在以后可能也会被访问**

所以CPU 每次获取数据都会先访问 cache，如果获取不到数据则把数据加载到 cache中进行访问。因为 cache 的大小是远远小于主存的，所以还需要在 cache和主存之间维护一个映射关系，这样才能正确找到数据。

缓存与主存之间地址的映射方式有：

1. **直接映射**：每个主存块只能放在一个**特定的位置**。Cache块号=主存块号%Cache块总数，总所周知，只要取模就会出现下标冲突的情况，这个时候就可能出现上一个数据的缓存失效。

2. **组相联**：Cache块分为若干组，每个主存块可以放到**特定分组内的任意一个位置**。组号=主存块号%分组数。较好的解决了直接映射的缓存失效问题。

3. **全相联**：主存块可以放在Cache的任意位置。

由于现在都是多核 CPU，加上CPU内部有缓存且需要数据存在共享的情况，所以需要一种机制保证在不同的CPU中看到的 cache 数据必须时一致的。最常用来处理多核 CPU 之间的缓存一致性协议就是 **MESI 协议**。MESI 协议是一种 **写失效**（Write Invalidate）的协议。在写失效协议里，在这个 CPU 核心将某个数据写入 cache 之后，它会去广播一个“失效”请求告诉所有其他的 CPU 核心更新此数据。

## 运算器

运算器主要是进行 **算术运算**（加减乘除）以及 **逻辑运算**(与& 或| 非^)。主要由以下部分组成：

![](/Users/jianhang/Library/Application%20Support/marktext/images/2023-12-16-16-29-47-image.png)

## 控制器

控制器的作用主要功能是解释指令、调度程序、读写存储器、输入输出数据等。主要组成：程序计数器(PC)、指令寄存器(IR)和控制单元(CU)。

- 程序计数器(PC)：存放下一条指令的地址，地址自动加1（顺序执行），或者根据用户指定的行为进行跳跃（条件分支）。

- 指令寄存器(IR)：存放当前执行的指令。

- 控制单元(CU)：分析指令，给出控制信号

## 中央处理器CPU

CPU是有运算器和控制器组成：

![](https://pic4.zhimg.com/v2-4b8e102d396ad3c46994b1db74f31df7_r.jpg)

**CPU中除了运算器和控制器还包括 时钟(用于计时) 和 许多的寄存器**用于保存状态和数据，例如：数据寄存器和地址寄存器，程序状态字寄存器，CPU使用数据寄存器和地址寄存器 跟 存储器进行交互。

- 数据寄存器：存放操作数。两个寄存器拼接可存放双字长的数据

- 地址寄存器：存放地址

- 程序状态字寄存器（PSW）：存放条件码和其他状态信息，例如标记操作系统目前处于用户态还是核心态。

CPU的指令执行流程可以分为5个阶段: 取指令、分析指令、执行指令、访问取数、结果写回。

1. 取指令阶段：将内存中的指令读取到CPU中寄存器的过程，程序计数器存储下一条指令所在的地址；

2. 解析执行阶段：指令编码器按照预先的指令格式，对取出的指令进行拆分和解释，识别不同的指令类别和各种获取操作数的方法；

3. 执行指令阶段：完成指令所规定的各种操作，具体实现指令的功能；

4. 访问取数阶段：根据指令地址码，得到操作数在主存中的地址，并从主存中读取该操作数用于运算；

5. 结果写回阶段：把执行指令阶段的运行结果数据“写回”到某种存储形式，结果数据经常被写到CPU的内部寄存器中，以便被后续的指令快速地存取。

# 操作系统

**操作系统**(Operating System，OS) 是一个运行在计算机上的**系统软件** ，管理着计算机硬件和软件资源，可以对资源合理的进行调度和分配。还**提供了统一的接口**给用户和其他软件使用。

操作系统主要完成的功能：进程管理、内存管理、文件管理、设备管理。

操作系统的特性

- 并发：在一段时间内，宏观上有多个程序同时运行
- 共享：系统中的资源可以被多个程序访问。包括 互斥访问 和 同时访问。
- 虚拟：通过某种技术把一个物理实体变为若干个逻辑上的对应物，例如内存的管理，内存才几G，但程序数据需要好几十G，这个时候就通过虚拟技术来管理内存。
- 异步：多个进程运行的顺序是无法预知的。

### 用户态和核心态

在计算机系统中，分两种程序：系统程序和应用程序。**为了保证 系统程序 不被 应用程序 有意或无意地破坏**，计算机设置了两种状态—— **用户态、核心态**。

- **用户态**：只能受限的访问内存 ，只能执行非特权指令，运行所有的应用程序。
- **核心态**：可以访问所有数据，可以运行特权指令和非特权指令，运行系统程序。

> 使用 ==程序状态字寄存器==（PSW）中的某个标志位来标识当前CPU的状态。如0是用户态，1是核心态。
> 
> 用户态 必须使用**中断**才可以切换到 核心态，然后修改PSW的标记位。
> 
> 核心态 切换到用户态则可以直接修改PSW的标记位。




