# 疑问

1.   为什么要使用定时任务的方式
2.   我不太明白钧姐说的软路由key和环境之间的关系
2.   如果noah下有多个环境的话怎么确定要用哪一个。



1.   调研了如何通过pmo进行自动部署，然后把大致思路整理wiki发给杰哥看。
2.   因为在调研过程中发现了一个pmo可能存在多个环境，所以把之前pmo自动关联环境的接口修改了一下。当出现多个环境时可以正常使用。改完之后进行了发布。
3.   刚才跟了解了一下杰哥本周的需求。



根据appcode和环境类型 得到 具体的环境名以及环境下每个机器的信息：

http://cmapi.corp.qunar.com/api/portal/env/query/envlist?app_code=f_haders_linker&env_type=prod&is_host_ret=1

根据pmo拿到所有关联的appcode：（需要根据f_过滤）

http://qa.corp.qunar.com/qodin/api/common/v1/pmo_projects/FD-94699 

根据pmo获取到软路由环境id：

 http://noah3.corp.qunar.com/pmo/query/soft?pmo=PT-99361

根据软路由软件id获得基准环境id：

https://noah3.corp.qunar.com/envBase/base/env?envId=435868

根据环境id获取到环境名：

https://noah3.corp.qunar.com/api/v1/getEnvCodeByEnvId?envId=435868





# 灭霸部署逻辑

定时任务去处理同步：@QSchedule("com.qunar.flight.automate.autosync.prodautoenv")

实际会来到此方法：

```
autoSyncProdService.autoSync();
```

1.   获取维护了需要自动同步prod分组的app_codes集合
2.   遍历处理每一个app_code。autoSync(appCodesSet);



## autoSync(appCodesSet);

2.1 查该appcode有没有在跑的task，如果有，则不同步。

2.2 获取和校验基准环境信息 getOnlineSettings(appCode)，如果没有基准环境信息则跳过。

2.3 同步本身 syncSelf(appCode, onlineEnv)

2.4 获取该应用关联的其他app_codes,并进行同步



### getOnlineSettings(appCode)

1.   获取基准环境信息：获取所有的接口配置，并从中获取所有的基准环境配置，放入一个set中。
2.   校验每个基准环境的信息：
     1.   判断要同步哪个环境
          1.   分别有prod、simulation、noah、prepare、beta
          2.   不同步线上环境
          3.   prepare环境如果profile包含off或者auto才进行同步
     2.   获取对应环境的profileId：

```java
/ 获取环境详情
String ENV_LIST = "http://cmapi.corp.qunar.com/api/portal/env/query/envlist?app_code=%s&env_type=%s&is_host_ret=1&ip_request=1";
```

>   返回格式参考：http://cmapi.corp.qunar.com/api/portal/env/query/envlist?app_code=f_ttsi_router&env_type=prepare&is_host_ret=1&ip_request=1



### syncSelf(appCode, onlineEnv)

1.   根据git地址返回的sourceUrl获取最新的rtag，如果rtag一致则不部署

```
根据appcode 获取代码git地址：http://cmapi.corp.qunar.com/api/portal/appcode/query/buildparam?app_code=f_ttsi_router&env_name=prepareautotest
```

2.   构建发布请求（各种请求，然后组装成请求参数）
3.   进行发布portalService.deploySync(portalBuildRequest, ""); 实际是发起post请求

```java
String PORTAL_DEPLOY = "http://portal.corp.qunar.com/api/apptask/task/common_single_exec";
```









# diff项目实现自动部署方案

## 大致思路

>   用户点击执行按钮，先进行部署，再跑case

1.   根据pmo获得appcode和软路由环境信息

     -   根据pmo拿到所有关联的appcode（需要根据f_过滤）：http://qa.corp.qunar.com/qodin/api/common/v1/pmo_projects/FD-94699

     -   根据pmo获取到软路由环境id：http://noah3.corp.qunar.com/pmo/query/soft?pmo=PT-99361
     -   根据环境id获取到环境名：https://noah3.corp.qunar.com/api/v1/getEnvCodeByEnvId?envId=435868

2.   由于一个pmo下可能存在多个appcode和软路由环境，所以循环进行以下操作:

     1.   根据 appcode 和 软路由环境名 构建发布参数
     2.   请求发布接口，进行发布



## 目前问题

1.   目前只能根据pmo分别获取全部的appcode和软路由环境，如果出现多个appcode的情况下，不能确定哪个appcode对应哪个软路由环境（应该有办法确定，但还没调研到）。
2.   发布接口的请求参数有些不确定该如何填。例如分支名。





## 构建参数

构建部署参考wiki：https://wiki.corp.qunar.com/confluence/pages/viewpage.action?pageId=194353739

以下构建参数代码参考灭霸：（除了有注释的，其他都可以直接使用灭霸代码）

```java
private PortalBuildRequest buildPortalRequest(String appCode, String envName) {
    //获取envType，我们可以固定写成beta？
    String envType = "beta";

    PortalBuildRequest portalJobBuild = new PortalBuildRequest();
    PortalBuildParams portalBuildParams = new PortalBuildParams();
    List<PortalAppParams> appParams = Lists.newArrayList();
    PortalAppParams portalAppParams = new PortalAppParams();
    List<PortalEnvParams> envList = Lists.newArrayList();
    PortalEnvParams portalEnvParams = new PortalEnvParams();

    portalEnvParams.setEnvId(envName);
    portalEnvParams.setServers(cmapiService.getDeployServers(appCode, envName));
    envList.add(portalEnvParams);
    portalAppParams.setAppCode(appCode);
    portalAppParams.setDeployForced(false);
    portalAppParams.setDeployStage(true);
    // 目前还不知道如何确定分支（有待调研）
    portalAppParams.setInputTag("last rtag");
    // 机器列表可以不传
    portalAppParams.setEnvList(envList);

    appParams.add(portalAppParams);

    portalBuildParams.setAppParams(appParams);
    portalBuildParams.setDeployType(envType);
    portalBuildParams.setPmoId(Constants.DEPLOY_PMOID);
    portalJobBuild.setBuildParams(portalBuildParams);
    // 22E 是cm给的
    portalJobBuild.setChannelId("22E" + System.currentTimeMillis());

    return portalJobBuild;
}
```



